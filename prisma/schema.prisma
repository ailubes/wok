// This is your Prisma schema file for AgroLaw Vote
// Database: PostgreSQL
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed configuration
// Run: npm run seed

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  MEMBER
  OBSERVER
}

enum BillStatus {
  ACTIVE
  ARCHIVED
}

enum ArticleStatus {
  NOT_PROCESSED // Gray - not reviewed yet
  IN_DISCUSSION // Yellow - has proposals/comments
  APPROVED // Green - proposal approved
  REJECTED // Red - proposal rejected, keep original
}

enum ProposalStatus {
  DRAFT
  VOTING
  APPROVED
  REJECTED
}

enum VoteValue {
  APPROVE
  REJECT
  ABSTAIN
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  organization String?
  role         UserRole @default(MEMBER)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  proposals Proposal[]
  votes     Vote[]
  comments  Comment[]

  @@map("users")
}

model Bill {
  id                 String     @id @default(uuid())
  title              String
  registrationNumber String?    @map("registration_number")
  description        String?    @db.Text
  status             BillStatus @default(ACTIVE)
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  articles Article[]

  @@map("bills")
}

model Article {
  id             String        @id @default(uuid())
  billId         String        @map("bill_id")
  articleNumber  String        @map("article_number")
  title          String?
  currentLawText String?       @map("current_law_text") @db.Text
  draftBillText  String        @map("draft_bill_text") @db.Text
  tags           String[]      @default([])
  orderIndex     Int           @map("order_index")
  status         ArticleStatus @default(NOT_PROCESSED)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  bill      Bill       @relation(fields: [billId], references: [id], onDelete: Cascade)
  proposals Proposal[]
  comments  Comment[]

  @@map("articles")
}

model Proposal {
  id            String         @id @default(uuid())
  articleId     String         @map("article_id")
  authorId      String         @map("author_id")
  proposedText  String         @map("proposed_text") @db.Text
  justification String?        @db.Text
  status        ProposalStatus @default(DRAFT)
  votingEndsAt  DateTime?      @map("voting_ends_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])
  votes   Vote[]

  @@map("proposals")
}

model Vote {
  id         String    @id @default(uuid())
  proposalId String    @map("proposal_id")
  userId     String    @map("user_id")
  value      VoteValue
  createdAt  DateTime  @default(now()) @map("created_at")

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([proposalId, userId])
  @@map("votes")
}

model Comment {
  id        String   @id @default(uuid())
  articleId String   @map("article_id")
  userId    String   @map("user_id")
  text      String   @db.Text
  parentId  String?  @map("parent_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  article Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@map("comments")
}
